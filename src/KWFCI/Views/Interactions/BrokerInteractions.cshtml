@model KWFCI.Models.ViewModels.InteractionVM

@{
    ViewBag.Title = "Interactions";
}

<div>
    <div class="col-xs-12">
        
        <table class="table table-bordered editTable">
            <thead>
                <tr>
                    <th>Staff</th>
                    <th>Notes</th>
                    <th>Date</th>
                    <th>Next Step</th>
                    <th>Broker</th>
                </tr>
            </thead>
            <tbody >
                @foreach (Interaction a in Model.Interactions)
                {
                    var entityID = a.InteractionID;
                    
                    var test = a.TaskForeignKey;
                    
                    <tr>
                        <td style="text-align:center;width:200px;vertical-align:middle;">@ViewBag.StaffEmail</td>
                        <td style="min-width:380px;max-width:380px;height:100%;">
                            <div class="col-xs-12 " style="height:100%;">
                                <a href="#" class="inactive" data-toggle="modal" data-target="#editInteractionNotes" data-id="@entityID" style="height:100%;">
                                    @if (a.Notes != null && a.Notes != "")
                                    {
                                        <div style="height:100%;" data-id="@entityID"><span class="align-middle">@a.Notes</span></div>
                                    }
                                    else
                                    {
                                        <div style="height:100%;" data-id="@entityID"><span class="align-middle"></span></div>
                                    }
                                </a>
                            </div>
                        </td>

                        
                        <td style="min-width:110px;max-width:110px;" asp-for="@Model.NewInteraction.DateCreated">
                            <!--Attribute necessary for datepicker to function: data-provide="datepicker"
                                Attributes that serve as configuration options: all attributes that start with data-date- -->
                            <input type="text" data-date-autoclose="true" data-date-clear-btn="true" data-date-today-highlight="true" data-provide="datepicker" class="form-control interactionDate" data-id="@entityID"
                            @if (a.DateCreated != null)
                            {
                                //Remove the time from the display
                                string[] splitDate = a.DateCreated.ToString().Split(' ');
                                string date = splitDate[0];

                                @:value="@date" />
                            }
                            else
                            {
                                @:value="" />
                            }
                        </td>

                        
                        <td style="min-width:380px;max-width:380px;height:100%;">
                            <div class="col-xs-10" style="height:100%;">
                                <a href="#" class="inactive" data-toggle="modal" data-target="#editInteractionNextStep" data-id="@entityID" style="height:100%;">
                                    @if (a.NextStep != null && a.NextStep != "")
                                    {
                                        <div style="height:100%;" data-id="@entityID"><span class="align-middle">@a.NextStep</span></div>
                                    }
                                    else
                                    {
                                        <div style="height:100%;" data-id="@entityID"><span class="align-middle"></span></div>
                                    }
                                </a>
                            </div>
                            @if (a.TaskForeignKey == null)
                            {
                                <div class="col-xs-2" style="height:100%;">
                                    <button type="button" class="btn btn-success" style="padding: 0px 7px 0px 7px;float:right;height:100%;" data-toggle="modal" data-target="#newKWTaskFromInteractionModal" data-id="@entityID">
                                        <div><i style="font-size:18px;" class="fa fa-bell-o" aria-hidden="true"></i></div>
                                    </button>
                                </div>
                            }
                            else
                            {
                                //KWTask task = Model.Tasks.Where(t => t.KWTaskID == a.TaskForeignKey) as KWTask;
                                //KWTask test = (from t in Model.Tasks where t.KWTaskID == a.TaskForeignKey select t) as KWTask;
                                KWTask task = new KWTask();
                                foreach (KWTask t in Model.Tasks) //Linq not working
                                {
                                    if(t.KWTaskID == a.TaskForeignKey)
                                    {
                                        task = t;
                                    }
                                }
                                <div class="col-xs-2" style="height:100%;">
                                    <button type="button" class="btn btn-primary" style="padding: 0px 7px 0px 7px;float:right;height:100%;" data-task-fk="@a.TaskForeignKey" data-toggle="modal" data-target="#editKWTaskFromInteractionModal" data-id="@entityID">
                                        <div><i style="font-size:18px;" class="fa fa-bell-o" aria-hidden="true"></i></div>
                                    </button>

                                    <input type="hidden" class="view-TaskAlertDate" value="@task.AlertDate" />
                                    <input type="hidden" class="view-TaskDateDue" value="@task.DateDue" />
                                    <input type="hidden" class="view-TaskMessage" value="@task.Message" />
                                    <input type="hidden" class="view-TaskPriority" value="@task.Priority" />
                                    <input type="hidden" class="view-TaskKWTaskID" value="@task.KWTaskID" />
                                </div>
                            }
                        </td>
                        
                        
                        <td style="width:200px;text-align:center;vertical-align:middle;">
                            @ViewBag.BrokerName
                        </td>
                    </tr>
             }
            </tbody>
        </table>
        <button class="btn btn-sm btn-success kwAddButton" type="button" style="margin-top:10px;"
                onclick="location.href='@Url.Action("Add", "Interactions", new { BrokerID = Model.Broker.BrokerID })'">
            <span>New Interaction</span>
        </button>
        
    </div>
</div>

<form class="hidden" asp-action="Edit" asp-controller="Interactions">
    <!--Value is populated with jQuery based on what value was entered into the date box-->
    <input type="hidden" class="addDate" asp-for="@Model.NewInteraction.DateCreated" value=""/>
    <input type="hidden" class="addID" asp-for="@Model.NewInteraction.InteractionID" value="" />
    <input type="hidden" asp-for="@Model.Field" value="Date Created" />
    <input type="hidden" asp-for="@Model.BrokerID" />
    <!--Triggered with jQuery-->
    <button type="submit" class="hidden submitButton"></button>
</form>




    

@Html.Partial("Modals/_EditKWTaskFromInteractionModal", Model)
@Html.Partial("Modals/_NewKWTaskFromInteractionModal", Model)
@Html.Partial("Modals/_EditInteractionNotesModal", Model)
@Html.Partial("Modals/_EditInteractionNextStepModal", Model)
<style>
    table, tr, th {
        border: 1px solid black;
    }
</style>
